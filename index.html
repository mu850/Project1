<!DOCTYPE html>
<html lang="ur" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø¢Ù¹Ø§ Ú†Ú©ÛŒ Ú©ÛŒÙ„Ú©ÙˆÙ„ÛŒÙ¹Ø±</title>
    <!-- PWA Manifest -->
    <link rel="manifest" href="/manifest.json">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Naskh+Arabic+Urdu:wght@400..700&display=swap');

        body {
            font-family: 'Noto Naskh Arabic Urdu', sans-serif;
            background-color: #f0f2f5;
            direction: rtl;
        }
        .container {
            max-width: 600px;
        }
        .card {
            background-color: #ffffff;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .btn {
            padding: 1rem 2rem;
            border-radius: 9999px;
            font-size: 1.25rem;
            font-weight: bold;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .input-field {
            width: 100%;
            padding: 0.75rem;
            border-radius: 8px;
            border: 1px solid #d1d5db;
            text-align: right;
            font-size: 1rem;
        }
        .checkbox-label {
            display: flex;
            align-items: center;
            justify-content: flex-end;
            cursor: pointer;
        }
        .checkbox-label input {
            margin-right: 0.5rem;
            margin-left: 0.5rem;
        }
        /* Modal styles */
        .modal {
            position: fixed;
            top: 0;
            right: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-content {
            background: white;
            padding: 2rem;
            border-radius: 8px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.25);
            max-width: 90%;
            width: 400px;
        }
        .payment-history-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 0;
            border-bottom: 1px dashed #ccc;
        }
        .payment-history-item:last-child {
            border-bottom: none;
        }
        .transactions-list {
            max-height: 200px;
            overflow-y: auto;
        }
        .transaction-item {
            border-bottom: 1px solid #e5e7eb;
            padding: 0.5rem 0;
        }
        details > summary {
            list-style: none;
        }
        details > summary::-webkit-details-marker {
            display: none;
        }
    </style>
</head>
<body class="p-4">

    <div class="container mx-auto">
        <h1 class="text-3xl font-bold text-center my-8 text-gray-800">Ø¢Ù¹Ø§ Ú†Ú©ÛŒ Ú©ÛŒÙ„Ú©ÙˆÙ„ÛŒÙ¹Ø±</h1>

        <!-- Form Section -->
        <div id="form-section" class="card p-6 mb-8">
            <form id="calculator-form" class="space-y-6">
                <div>
                    <label for="customerName" class="block text-right text-gray-700">Ú©Ø³Ù¹Ù…Ø± Ú©Ø§ Ù†Ø§Ù…</label>
                    <input type="text" id="customerName" class="input-field" placeholder="Ú©Ø³Ù¹Ù…Ø± Ú©Ø§ Ù†Ø§Ù… Ø¯Ø±Ø¬ Ú©Ø±ÛŒÚº" required>
                </div>
                <div>
                    <label for="totalWeight" class="block text-right text-gray-700">Ú©Ù„ ÙˆØ²Ù† (Ú©Ù„ÙˆÚ¯Ø±Ø§Ù…)</label>
                    <input type="number" step="0.01" id="totalWeight" class="input-field" placeholder="Ú©Ù„ ÙˆØ²Ù†" required>
                </div>
                <div>
                    <label for="flourRatePerKg" class="block text-right text-gray-700">Ø¢Ù¹Û’ Ú©ÛŒ ÙÛŒ Ú©Ù„Ùˆ Ù‚ÛŒÙ…Øª (Ø±ÙˆÙ¾Û’)</label>
                    <input type="number" step="0.01" id="flourRatePerKg" class="input-field" placeholder="Ø¢Ù¹Û’ Ú©ÛŒ Ù‚ÛŒÙ…Øª" required>
                </div>
                <div>
                    <label for="advanceFlour" class="block text-right text-gray-700">Ø§ÛŒÚˆÙˆØ§Ù†Ø³ Ø¢Ù¹Ø§ (Ú©Ù„ÙˆÚ¯Ø±Ø§Ù…)</label>
                    <input type="number" step="0.01" id="advanceFlour" class="input-field" placeholder="Ø§ÛŒÚˆÙˆØ§Ù†Ø³ Ø¢Ù¹Ø§">
                </div>
                <div class="flex items-center justify-between">
                    <label for="noSafai" class="checkbox-label text-gray-700">ØµÙØ§Ø¦ÛŒ Ù†ÛÛŒÚº Ú©Ø±Ù†ÛŒ (Ù¾Ø³Ø§Ø¦ÛŒ Ú©ÛŒ Ù‚ÛŒÙ…Øª 3.00 Ø±ÙˆÙ¾Û’ ÛÙˆ Ø¬Ø§Ø¦Û’ Ú¯ÛŒ)</label>
                    <input type="checkbox" id="noSafai" class="w-5 h-5">
                </div>
                <div class="flex items-center justify-between">
                    <label for="noKatoti" class="checkbox-label text-gray-700">Ú©Ù¹ÙˆØªÛŒ Ù†ÛÛŒÚº Ú©Ø±Ù†ÛŒ</label>
                    <input type="checkbox" id="noKatoti" class="w-5 h-5">
                </div>
                <div class="flex items-center justify-between">
                    <label for="billInFlour" class="checkbox-label text-gray-700">Ø¨Ù„ Ø¢Ù¹Ø§ Ø³Û’ Ø§Ø¯Ø§ ÛÙˆÚ¯Ø§</label>
                    <input type="checkbox" id="billInFlour" class="w-5 h-5">
                </div>
                <button type="submit" class="w-full bg-blue-500 hover:bg-blue-600 text-white btn transition-colors">Ø­Ø³Ø§Ø¨ Ú©Ø±ÛŒÚº</button>
            </form>
        </div>

        <!-- Receipt Section -->
        <div id="receipt-section" class="card p-6 mb-8 hidden">
            <h2 class="text-2xl font-bold text-center mb-4 text-gray-800">Ø±Ø³ÛŒØ¯</h2>
            <div id="receipt-details" class="text-gray-700 leading-8"></div>
            <div class="flex flex-col sm:flex-row space-y-4 sm:space-y-0 sm:space-x-4 mt-6 justify-center">
                <button id="save-backup-btn" class="bg-green-500 hover:bg-green-600 text-white btn transition-colors">âœ… ØªØµØ¯ÛŒÙ‚</button>
                <button id="save-khata-btn" class="bg-orange-500 hover:bg-orange-600 text-white btn transition-colors">ğŸ“’ Ú©Ú¾Ø§ØªÛ Ù…ÛŒÚº Ø´Ø§Ù…Ù„ Ú©Ø±ÛŒÚº</button>
                <button id="delete-receipt-btn" class="bg-red-500 hover:bg-red-600 text-white btn transition-colors">âŒ Ø®ØªÙ… Ú©Ø±ÛŒÚº</button>
            </div>
        </div>

        <!-- Records Section -->
        <div class="card p-6">
            <h2 class="text-2xl font-bold text-center mb-4 text-gray-800">Ø±ÛŒÚ©Ø§Ø±ÚˆØ²</h2>
            <div class="flex flex-col sm:flex-row space-y-4 sm:space-y-0 sm:space-x-4 mb-4">
                <select id="record-type-dropdown" class="flex-1 input-field">
                    <option value="default" selected disabled>Ø±ÛŒÚ©Ø§Ø±Úˆ Ø¯ÛŒÚ©Ú¾ÛŒÚº</option>
                    <option value="backup">Ø¨ÛŒÚ© Ø§Ù¾</option>
                    <option value="khata">Ú©Ú¾Ø§ØªÛ’ ÙˆØ§Ù„Ø§</option>
                    <option value="summary">Ù…Ø¬Ù…ÙˆØ¹ÛŒ Ø±ÛŒÚ©Ø§Ø±Úˆ</option>
                </select>
                <div class="flex-1">
                    <label for="date-filter" class="sr-only">ØªØ§Ø±ÛŒØ®</label>
                    <input type="date" id="date-filter" class="input-field mb-2" placeholder="ØªØ§Ø±ÛŒØ®">
                </div>
                <button id="view-records-btn" class="bg-blue-500 hover:bg-blue-600 text-white py-2 px-4 rounded-full transition-colors font-bold">Ø¯ÛŒÚ©Ú¾ÛŒÚº</button>
            </div>

            <div id="records-list" class="space-y-4" onclick="handleRecordAction(event)">
            </div>
            <div id="summary-section" class="hidden text-center text-gray-800">
                <p class="text-xl font-bold">Ú©Ù„ Ø®Ø§Ù„Øµ ÙˆØ²Ù†: <span id="total-net-weight"></span> Ú©Ù„ÙˆÚ¯Ø±Ø§Ù…</p>
                <p class="text-xl font-bold">Ú©Ù„ Ú©Ù¹ÙˆØªÛŒ Ú©Ø§ ÙˆØ²Ù†: <span id="total-katoti-weight"></span> Ú©Ù„ÙˆÚ¯Ø±Ø§Ù…</p>
                <p class="text-xl font-bold">Ú©Ù„ Ø±Ù‚Ù…: <span id="total-amount"></span> Ø±ÙˆÙ¾Û’</p>
            </div>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div id="confirmation-modal" class="modal hidden">
        <div class="modal-content text-right">
            <h3 class="text-xl font-bold mb-4">ØªØµØ¯ÛŒÙ‚</h3>
            <p id="confirmation-text" class="mb-4">Ú©ÛŒØ§ Ø¢Ù¾ ÙˆØ§Ù‚Ø¹ÛŒ ÛŒÛ Ø±ÛŒÚ©Ø§Ø±Úˆ Ù…Ø­ÙÙˆØ¸ Ú©Ø±Ù†Ø§ Ú†Ø§ÛØªÛ’ ÛÛŒÚºØŸ</p>
            <div class="flex justify-end space-x-2 space-x-reverse">
                <button id="cancel-action-btn" class="bg-gray-500 hover:bg-gray-600 text-white py-2 px-4 rounded-full transition-colors">Ù…Ù†Ø³ÙˆØ® Ú©Ø±ÛŒÚº</button>
                <button id="confirm-action-btn" class="bg-green-500 hover:bg-green-600 text-white py-2 px-4 rounded-full transition-colors">ØªØµØ¯ÛŒÙ‚</button>
            </div>
        </div>
    </div>
    
    <!-- Payment Modal -->
    <div id="payment-modal" class="modal hidden">
        <div class="modal-content text-right">
            <h3 class="text-xl font-bold mb-4">ÙˆØµÙˆÙ„ÛŒ Ú©ÛŒ ØªÙØµÛŒÙ„Ø§Øª</h3>
            <p class="mb-4">Ø¨Ù‚Ø§ÛŒØ§ Ø±Ù‚Ù…: <span id="payment-amount-display" class="font-bold"></span> Ø±ÙˆÙ¾Û’</p>
            <div class="mb-4">
                <label for="paid-amount" class="block text-gray-700">ÙˆØµÙˆÙ„ Ø´Ø¯Û Ø±Ù‚Ù…:</label>
                <input type="number" step="0.01" id="paid-amount" class="input-field mt-1" placeholder="Ø±Ù‚Ù… Ø¯Ø±Ø¬ Ú©Ø±ÛŒÚº">
            </div>
            <div class="flex justify-end space-x-2 space-x-reverse">
                <button id="close-modal-btn" class="bg-gray-500 hover:bg-gray-600 text-white py-2 px-4 rounded-full transition-colors">Ù…Ù†Ø³ÙˆØ® Ú©Ø±ÛŒÚº</button>
                <button id="submit-payment-btn" class="bg-green-500 hover:bg-green-600 text-white py-2 px-4 rounded-full transition-colors">Ø¬Ù…Ø¹ Ú©Ø±Ø§Ø¦ÛŒÚº</button>
            </div>
        </div>
    </div>
    
    <!-- Add Weight Modal -->
    <div id="add-weight-modal" class="modal hidden">
        <div class="modal-content text-right space-y-4">
            <h3 class="text-xl font-bold mb-4">ÙˆØ²Ù† Ø´Ø§Ù…Ù„ Ú©Ø±ÛŒÚº</h3>
            <p class="mb-4">Ú©Ø³Ù¹Ù…Ø±: <span id="add-weight-customer-name" class="font-bold"></span></p>
            <div>
                <label for="additional-weight" class="block text-gray-700">Ø§Ø¶Ø§ÙÛŒ ÙˆØ²Ù† (Ú©Ù„ÙˆÚ¯Ø±Ø§Ù…):</label>
                <input type="number" step="0.01" id="additional-weight" class="input-field mt-1" placeholder="Ø§Ø¶Ø§ÙÛŒ ÙˆØ²Ù†">
            </div>
            <div>
                <label for="addFlourRatePerKg" class="block text-gray-700">Ø¢Ù¹Û’ Ú©ÛŒ ÙÛŒ Ú©Ù„Ùˆ Ù‚ÛŒÙ…Øª (Ø±ÙˆÙ¾Û’)</label>
                <input type="number" step="0.01" id="addFlourRatePerKg" class="input-field" placeholder="Ø¢Ù¹Û’ Ú©ÛŒ Ù‚ÛŒÙ…Øª">
            </div>
            <div>
                <label for="addAdvanceFlour" class="block text-gray-700">Ø§ÛŒÚˆÙˆØ§Ù†Ø³ Ø¢Ù¹Ø§ (Ú©Ù„ÙˆÚ¯Ø±Ø§Ù…)</label>
                <input type="number" step="0.01" id="addAdvanceFlour" class="input-field" placeholder="Ø§ÛŒÚˆÙˆØ§Ù†Ø³ Ø¢Ù¹Ø§">
            </div>
            <div class="flex items-center justify-between">
                <label for="addNoSafai" class="checkbox-label text-gray-700">ØµÙØ§Ø¦ÛŒ Ù†ÛÛŒÚº Ú©Ø±Ù†ÛŒ</label>
                <input type="checkbox" id="addNoSafai" class="w-5 h-5">
            </div>
            <div class="flex items-center justify-between">
                <label for="addNoKatoti" class="checkbox-label text-gray-700">Ú©Ù¹ÙˆØªÛŒ Ù†ÛÛŒÚº Ú©Ø±Ù†ÛŒ</label>
                <input type="checkbox" id="addNoKatoti" class="w-5 h-5">
            </div>
            <div class="flex items-center justify-between">
                <label for="addBillInFlour" class="checkbox-label text-gray-700">Ø¨Ù„ Ø¢Ù¹Ø§ Ø³Û’ Ø§Ø¯Ø§ ÛÙˆÚ¯Ø§</label>
                <input type="checkbox" id="addBillInFlour" class="w-5 h-5">
            </div>
            <div class="flex justify-end space-x-2 space-x-reverse">
                <button id="close-add-modal-btn" class="bg-gray-500 hover:bg-gray-600 text-white py-2 px-4 rounded-full transition-colors">Ù…Ù†Ø³ÙˆØ® Ú©Ø±ÛŒÚº</button>
                <button id="submit-add-weight-btn" class="bg-green-500 hover:bg-green-600 text-white py-2 px-4 rounded-full transition-colors">Ø´Ø§Ù…Ù„ Ú©Ø±ÛŒÚº</button>
            </div>
        </div>
    </div>

    <script>
        // PWA Service Worker Registration
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/service-worker.js').then(registration => {
                    console.log('Service Worker registered with scope:', registration.scope);
                }).catch(err => {
                    console.error('Service Worker registration failed:', err);
                });
            });
        }

        // Constants
        const GRINDING_RATE_WITH_SAFAI = 4.25;
        const GRINDING_RATE_WITHOUT_SAFAI = 3.00;

        // DOM Elements
        const form = document.getElementById('calculator-form');
        const receiptSection = document.getElementById('receipt-section');
        const receiptDetails = document.getElementById('receipt-details');
        const recordTypeDropdown = document.getElementById('record-type-dropdown');
        const dateFilter = document.getElementById('date-filter');
        const viewRecordsBtn = document.getElementById('view-records-btn');
        const recordsList = document.getElementById('records-list');
        const summarySection = document.getElementById('summary-section');
        const totalNetWeightSpan = document.getElementById('total-net-weight');
        const totalKatotiWeightSpan = document.getElementById('total-katoti-weight');
        const totalAmountSpan = document.getElementById('total-amount');

        // Modals
        const paymentModal = document.getElementById('payment-modal');
        const paymentAmountDisplay = document.getElementById('payment-amount-display');
        const paidAmountInput = document.getElementById('paid-amount');
        const closeModalBtn = document.getElementById('close-modal-btn');
        const submitPaymentBtn = document.getElementById('submit-payment-btn');
        
        const confirmationModal = document.getElementById('confirmation-modal');
        const confirmationText = document.getElementById('confirmation-text');
        const confirmActionBtn = document.getElementById('confirm-action-btn');
        const cancelActionBtn = document.getElementById('cancel-action-btn');
        
        const addWeightModal = document.getElementById('add-weight-modal');
        const addWeightCustomerName = document.getElementById('add-weight-customer-name');
        const additionalWeightInput = document.getElementById('additional-weight');
        const closeAddModalBtn = document.getElementById('close-add-modal-btn');
        const submitAddWeightBtn = document.getElementById('submit-add-weight-btn');

        let currentReceiptData = null;
        let editingRecordId = null;
        let editingRecordType = null;
        let currentRecordToPay = null;
        let currentRecordToAddWeight = null;
        let currentAction = null; // To differentiate between save and delete confirmations

        // Add event listener to the new "View" button
        viewRecordsBtn.addEventListener('click', () => {
            const selectedType = recordTypeDropdown.value;
            if (selectedType === 'summary') {
                renderSummary();
            } else if (selectedType === 'backup' || selectedType === 'khata') {
                renderRecords(selectedType);
            } else {
                recordsList.innerHTML = `<p class="text-center text-gray-500 mt-4">Ø§ÛŒÚ© Ø±ÛŒÚ©Ø§Ø±Úˆ Ú©ÛŒ Ù‚Ø³Ù… Ù…Ù†ØªØ®Ø¨ Ú©Ø±ÛŒÚº Ø§ÙˆØ± Ø¯ÛŒÚ©Ú¾ÛŒÚº Ù¾Ø± Ú©Ù„Ú© Ú©Ø±ÛŒÚºÛ”</p>`;
                summarySection.classList.add('hidden');
            }
        });

        // Handle form submission
        form.addEventListener('submit', (e) => {
            e.preventDefault();

            const customerName = document.getElementById('customerName').value;
            const totalWeight = parseFloat(document.getElementById('totalWeight').value) || 0;
            const flourRatePerKg = parseFloat(document.getElementById('flourRatePerKg').value) || 0;
            const advanceFlour = parseFloat(document.getElementById('advanceFlour').value) || 0;
            const noSafai = document.getElementById('noSafai').checked;
            const noKatoti = document.getElementById('noKatoti').checked;
            const billInFlour = document.getElementById('billInFlour').checked;
            
            if (billInFlour && flourRatePerKg <= 0) {
                 // Use a message box instead of alert
                 // alert("Ø§Ú¯Ø± Ø¨Ù„ Ø¢Ù¹Ø§ Ø³Û’ Ø§Ø¯Ø§ ÛÙˆÚ¯Ø§ ØªÙˆ Ø¢Ù¹Û’ Ú©ÛŒ Ù‚ÛŒÙ…Øª Ø¯Ø±Ø¬ Ú©Ø±Ù†Ø§ Ø¶Ø±ÙˆØ±ÛŒ ÛÛ’Û”");
                 return;
            }

            let netWeight = totalWeight;
            
            const actualGrindingRate = noSafai ? GRINDING_RATE_WITHOUT_SAFAI : GRINDING_RATE_WITH_SAFAI;

            const grindingCost = totalWeight * actualGrindingRate;
            
            const katotiWeight = totalWeight * 0.05;
            const katotiValue = katotiWeight * flourRatePerKg;

            let totalAmount = grindingCost;
            if (noKatoti) {
                totalAmount = grindingCost + katotiValue;
            }

            let flourEquivalent = 0;
            if (billInFlour) {
                flourEquivalent = totalAmount / flourRatePerKg;
            }

            if (!noKatoti) {
                netWeight -= katotiWeight;
            }
            
            if (advanceFlour > 0) {
                netWeight -= advanceFlour;
            }
            
            if (flourEquivalent > 0) {
                netWeight -= flourEquivalent;
            }
            
            const now = new Date();
            currentReceiptData = {
                id: editingRecordId || Date.now(),
                customerName,
                totalWeight: totalWeight.toFixed(2),
                flourRatePerKg: flourRatePerKg.toFixed(2),
                advanceFlour: advanceFlour.toFixed(2),
                netWeight: netWeight.toFixed(2),
                katotiWeight: katotiWeight.toFixed(2),
                grindingCost: grindingCost.toFixed(2),
                actualGrindingRate: actualGrindingRate.toFixed(2),
                katotiValue: katotiValue.toFixed(2),
                amount: totalAmount.toFixed(2),
                flourEquivalent: flourEquivalent.toFixed(2),
                balance: totalAmount.toFixed(2), 
                date: now.toLocaleDateString('ur-PK'),
                time: now.toLocaleTimeString('ur-PK', { hour: '2-digit', minute: '2-digit' }),
                timestamp: now.getTime(),
                noSafai,
                noKatoti,
                billInFlour,
                status: 'unpaid', 
                paymentHistory: [],
                transactions: [{
                    weight: totalWeight,
                    grindingCost: grindingCost,
                    amount: totalAmount,
                    date: now.toLocaleDateString('ur-PK'),
                    time: now.toLocaleTimeString('ur-PK', { hour: '2-digit', minute: '2-digit' }),
                    noSafai, noKatoti, billInFlour,
                    transactionType: 'Initial Entry'
                }]
            };

            displayReceipt();
        });

        function displayReceipt() {
            if (!currentReceiptData) return;
            
            const { customerName, totalWeight, advanceFlour, netWeight, katotiWeight, amount, date, time, noKatoti, flourEquivalent } = currentReceiptData;
            
            receiptDetails.innerHTML = `
                <p><strong>Ù†Ø§Ù…:</strong> ${customerName}</p>
                <p><strong>ÙˆØ²Ù†:</strong> ${totalWeight} Ú©Ù„ÙˆÚ¯Ø±Ø§Ù…</p>
                <p><strong>Ú©Ù¹ÙˆØªÛŒ Ú©Ø§ ÙˆØ²Ù†:</strong> ${katotiWeight} Ú©Ù„ÙˆÚ¯Ø±Ø§Ù…</p>
                <p><strong>Ø¨Ù„ Ø±Ù‚Ù…:</strong> ${amount} Ø±ÙˆÙ¾Û’</p>
                ${(flourEquivalent > 0) ? `<p><strong>Ø¨Ù„ Ø±Ù‚Ù… (Ø¢Ù¹Û’ Ù…ÛŒÚº):</strong> ${flourEquivalent} Ú©Ù„ÙˆÚ¯Ø±Ø§Ù…</p>` : ''}
                <p><strong>Ø®Ø§Ù„Øµ Ø¢Ù¹Ø§:</strong> ${netWeight} Ú©Ù„ÙˆÚ¯Ø±Ø§Ù…</p>
            `;
            
            receiptSection.classList.remove('hidden');
        }

        // Handle receipt button clicks
        document.getElementById('save-backup-btn').addEventListener('click', () => {
            currentAction = 'save-backup';
            confirmationText.textContent = 'Ú©ÛŒØ§ Ø¢Ù¾ ÙˆØ§Ù‚Ø¹ÛŒ ÛŒÛ Ø±ÛŒÚ©Ø§Ø±Úˆ Ø¨ÛŒÚ© Ø§Ù¾ Ù…ÛŒÚº Ù…Ø­ÙÙˆØ¸ Ú©Ø±Ù†Ø§ Ú†Ø§ÛØªÛ’ ÛÛŒÚºØŸ';
            confirmationModal.classList.remove('hidden');
        });
        document.getElementById('save-khata-btn').addEventListener('click', () => {
            currentAction = 'save-khata';
            confirmationText.textContent = 'Ú©ÛŒØ§ Ø¢Ù¾ ÙˆØ§Ù‚Ø¹ÛŒ ÛŒÛ Ø±ÛŒÚ©Ø§Ø±Úˆ Ú©Ú¾Ø§ØªÛ’ Ù…ÛŒÚº Ø´Ø§Ù…Ù„ Ú©Ø±Ù†Ø§ Ú†Ø§ÛØªÛ’ ÛÛŒÚºØŸ';
            confirmationModal.classList.remove('hidden');
        });
        document.getElementById('delete-receipt-btn').addEventListener('click', () => {
            currentReceiptData = null;
            editingRecordId = null;
            receiptSection.classList.add('hidden');
            form.reset();
        });

        confirmActionBtn.addEventListener('click', () => {
            confirmationModal.classList.add('hidden');
            if (currentAction === 'save-backup') {
                saveRecord('backup');
            } else if (currentAction === 'save-khata') {
                saveRecord('khata');
            } else if (currentAction === 'delete-record') {
                deleteRecord(currentRecordToPay.id, currentRecordToPay.type);
            } else if (currentAction === 'move-to-khata') {
                moveToKhata(currentRecordToPay.id);
            }
        });

        cancelActionBtn.addEventListener('click', () => {
            confirmationModal.classList.add('hidden');
            currentAction = null;
        });

        function saveRecord(type) {
            if (!currentReceiptData) return;

            const records = JSON.parse(localStorage.getItem(type)) || [];
            if (editingRecordId) {
                const recordIndex = records.findIndex(rec => rec.id === editingRecordId);
                if (recordIndex > -1) {
                    records[recordIndex] = currentReceiptData;
                }
            } else {
                records.push(currentReceiptData);
            }
            localStorage.setItem(type, JSON.stringify(records));

            currentReceiptData = null;
            editingRecordId = null;
            editingRecordType = null;
            receiptSection.classList.add('hidden');
            form.reset();
            viewRecordsBtn.click();
        }

        function moveToKhata(id) {
            const backupRecords = JSON.parse(localStorage.getItem('backup')) || [];
            const khataRecords = JSON.parse(localStorage.getItem('khata')) || [];
            
            const recordToMove = backupRecords.find(rec => rec.id === id);
            if (recordToMove) {
                if (!recordToMove.paymentHistory) {
                    recordToMove.paymentHistory = [];
                }
                khataRecords.push(recordToMove);
                const updatedBackup = backupRecords.filter(rec => rec.id !== id);
                localStorage.setItem('backup', JSON.stringify(updatedBackup));
                localStorage.setItem('khata', JSON.stringify(khataRecords));
            }
            viewRecordsBtn.click();
        }
        
        function handleRecordAction(event) {
            const target = event.target;
            const action = target.getAttribute('data-action');
            const id = parseFloat(target.getAttribute('data-id'));
            const type = target.getAttribute('data-type');
            if (!action || !id || !type) return;

            if (action === 'delete') {
                currentAction = 'delete-record';
                currentRecordToPay = {id, type};
                confirmationText.textContent = `Ú©ÛŒØ§ Ø¢Ù¾ ÙˆØ§Ù‚Ø¹ÛŒ ÛŒÛ Ø±ÛŒÚ©Ø§Ø±Úˆ (${type}) Ø³Û’ Ø­Ø°Ù Ú©Ø±Ù†Ø§ Ú†Ø§ÛØªÛ’ ÛÛŒÚºØŸ`;
                confirmationModal.classList.remove('hidden');
            } else if (action === 'edit') {
                editRecord(id, type);
            } else if (action === 'pay') {
                showPaymentModal(id, type);
            } else if (action === 'move-to-khata') {
                 currentAction = 'move-to-khata';
                 currentRecordToPay = {id, type};
                 confirmationText.textContent = 'Ú©ÛŒØ§ Ø¢Ù¾ ÙˆØ§Ù‚Ø¹ÛŒ ÛŒÛ Ø±ÛŒÚ©Ø§Ø±Úˆ Ú©Ú¾Ø§ØªÛ’ Ù…ÛŒÚº Ø´Ø§Ù…Ù„ Ú©Ø±Ù†Ø§ Ú†Ø§ÛØªÛ’ ÛÛŒÚºØŸ';
                 confirmationModal.classList.remove('hidden');
            } else if (action === 'add-weight') {
                showAddWeightModal(id, type);
            }
        }

        function deleteRecord(id, type) {
            const records = JSON.parse(localStorage.getItem(type)) || [];
            const updatedRecords = records.filter(record => record.id !== id);
            localStorage.setItem(type, JSON.stringify(updatedRecords));
            viewRecordsBtn.click();
        }

        function editRecord(id, type) {
            const records = JSON.parse(localStorage.getItem(type)) || [];
            const record = records.find(rec => rec.id === id);
            if (!record) return;

            if (!record.paymentHistory) {
                record.paymentHistory = [];
            }

            editingRecordId = id;
            editingRecordType = type;
            
            document.getElementById('customerName').value = record.customerName;
            document.getElementById('totalWeight').value = record.totalWeight;
            document.getElementById('flourRatePerKg').value = record.flourRatePerKg;
            document.getElementById('advanceFlour').value = record.advanceFlour;
            document.getElementById('noSafai').checked = record.noSafai;
            document.getElementById('noKatoti').checked = record.noKatoti;
            document.getElementById('billInFlour').checked = record.billInFlour;
            
            document.getElementById('form-section').scrollIntoView({ behavior: 'smooth' });
            receiptSection.classList.add('hidden');
        }

        function showPaymentModal(id, type) {
            const records = JSON.parse(localStorage.getItem(type)) || [];
            const record = records.find(rec => rec.id === id);
            if (!record) return;
            currentRecordToPay = record;
            paymentAmountDisplay.textContent = record.balance;
            paidAmountInput.value = '';
            paymentModal.classList.remove('hidden');
        }

        submitPaymentBtn.addEventListener('click', () => {
            const paidAmount = parseFloat(paidAmountInput.value) || 0;
            if (paidAmount <= 0) {
                // Use a message box instead of alert
                // alert('ÙˆØµÙˆÙ„ Ø´Ø¯Û Ø±Ù‚Ù… Ø¯Ø±Ø³Øª Ø¯Ø±Ø¬ Ú©Ø±ÛŒÚºÛ”');
                return;
            }

            const records = JSON.parse(localStorage.getItem('khata')) || [];
            const recordIndex = records.findIndex(rec => rec.id === currentRecordToPay.id);
            
            if (recordIndex > -1) {
                const newBalance = parseFloat(records[recordIndex].balance) - paidAmount;
                records[recordIndex].balance = newBalance.toFixed(2);

                const newPayment = {
                    date: new Date().toLocaleDateString('ur-PK'),
                    amount: paidAmount.toFixed(2)
                };
                if (!records[recordIndex].paymentHistory) {
                    records[recordIndex].paymentHistory = [];
                }
                records[recordIndex].paymentHistory.push(newPayment);

                if (newBalance <= 0) {
                    records[recordIndex].status = 'paid';
                }
                localStorage.setItem('khata', JSON.stringify(records));
            }

            currentRecordToPay = null;
            paymentModal.classList.add('hidden');
            viewRecordsBtn.click();
        });

        closeModalBtn.addEventListener('click', () => {
            currentRecordToPay = null;
            paymentModal.classList.add('hidden');
        });
        
        function showAddWeightModal(id, type) {
            const records = JSON.parse(localStorage.getItem(type)) || [];
            const record = records.find(rec => rec.id === id);
            if (!record) return;
            currentRecordToAddWeight = record;
            addWeightCustomerName.textContent = record.customerName;
            document.getElementById('additional-weight').value = '';
            document.getElementById('addFlourRatePerKg').value = record.flourRatePerKg;
            document.getElementById('addAdvanceFlour').value = 0;
            document.getElementById('addNoSafai').checked = record.noSafai;
            document.getElementById('addNoKatoti').checked = record.noKatoti;
            document.getElementById('addBillInFlour').checked = record.billInFlour;
            addWeightModal.classList.remove('hidden');
        }
        
        closeAddModalBtn.addEventListener('click', () => {
            currentRecordToAddWeight = null;
            addWeightModal.classList.add('hidden');
        });

        submitAddWeightBtn.addEventListener('click', () => {
            const additionalWeight = parseFloat(document.getElementById('additional-weight').value) || 0;
            const flourRatePerKg = parseFloat(document.getElementById('addFlourRatePerKg').value) || 0;
            const advanceFlour = parseFloat(document.getElementById('addAdvanceFlour').value) || 0;
            const noSafai = document.getElementById('addNoSafai').checked;
            const noKatoti = document.getElementById('addNoKatoti').checked;
            const billInFlour = document.getElementById('addBillInFlour').checked;

            if (additionalWeight <= 0) {
                // Use a message box instead of alert
                // alert('Ø§Ø¶Ø§ÙÛŒ ÙˆØ²Ù† Ø¯Ø±Ø³Øª Ø¯Ø±Ø¬ Ú©Ø±ÛŒÚºÛ”');
                return;
            }

            const records = JSON.parse(localStorage.getItem('khata')) || [];
            const recordIndex = records.findIndex(rec => rec.id === currentRecordToAddWeight.id);
            
            if (recordIndex > -1) {
                let updatedRecord = { ...records[recordIndex] };
                
                // Calculate new transaction details
                const actualGrindingRate = noSafai ? GRINDING_RATE_WITHOUT_SAFAI : GRINDING_RATE_WITH_SAFAI;
                const newGrindingCost = additionalWeight * actualGrindingRate;
                const newKatotiWeight = additionalWeight * 0.05;
                const newKatotiValue = newKatotiWeight * flourRatePerKg;
                
                let newTransactionAmount = newGrindingCost;
                if (noKatoti) {
                    newTransactionAmount = newGrindingCost + newKatotiValue;
                }

                let newTransactionNetWeight = additionalWeight;
                if (!noKatoti) {
                    newTransactionNetWeight -= newKatotiWeight;
                }
                
                let flourEquivalent = 0;
                if (billInFlour) {
                    flourEquivalent = newTransactionAmount / flourRatePerKg;
                    newTransactionNetWeight -= flourEquivalent;
                }
                
                if (advanceFlour > 0) {
                    newTransactionNetWeight -= advanceFlour;
                }

                const newTransaction = {
                    weight: additionalWeight.toFixed(2),
                    grindingCost: newGrindingCost.toFixed(2),
                    amount: newTransactionAmount.toFixed(2),
                    netWeight: newTransactionNetWeight.toFixed(2),
                    date: new Date().toLocaleDateString('ur-PK'),
                    time: new Date().toLocaleTimeString('ur-PK', { hour: '2-digit', minute: '2-digit' }),
                    noSafai, noKatoti, billInFlour,
                    transactionType: 'Weight Added'
                };

                // Update the main record with new totals
                updatedRecord.totalWeight = (parseFloat(updatedRecord.totalWeight) + additionalWeight).toFixed(2);
                updatedRecord.netWeight = (parseFloat(updatedRecord.netWeight) + newTransactionNetWeight).toFixed(2);
                updatedRecord.katotiWeight = (parseFloat(updatedRecord.katotiWeight) + newKatotiWeight).toFixed(2);
                updatedRecord.amount = (parseFloat(updatedRecord.amount) + newTransactionAmount).toFixed(2);
                updatedRecord.balance = (parseFloat(updatedRecord.balance) + newTransactionAmount).toFixed(2);
                
                // Add new transaction to history
                if (!updatedRecord.transactions) {
                    updatedRecord.transactions = [];
                }
                updatedRecord.transactions.push(newTransaction);
                
                // Check and update status
                if (parseFloat(updatedRecord.balance) > 0) {
                    updatedRecord.status = 'unpaid';
                }

                records[recordIndex] = updatedRecord;
                localStorage.setItem('khata', JSON.stringify(records));
            }

            currentRecordToAddWeight = null;
            addWeightModal.classList.add('hidden');
            viewRecordsBtn.click();
        });


        function renderRecords(selectedType) {
            const dateFilterValue = dateFilter.value;

            recordsList.innerHTML = '';
            summarySection.classList.add('hidden');

            const records = JSON.parse(localStorage.getItem(selectedType)) || [];
            
            let filteredRecords = records;
            if (dateFilterValue) {
                const filterDate = new Date(dateFilterValue).toLocaleDateString('ur-PK');
                filteredRecords = records.filter(record => record.date === filterDate);
            }
            
            if (filteredRecords.length === 0) {
                recordsList.innerHTML = `<p class="text-center text-gray-500 mt-4">Ú©ÙˆØ¦ÛŒ Ø±ÛŒÚ©Ø§Ø±Úˆ Ù…ÙˆØ¬ÙˆØ¯ Ù†ÛÛŒÚº ÛÛ’Û”</p>`;
                return;
            }

            filteredRecords.forEach(record => {
                const recordItem = document.createElement('div');
                recordItem.className = 'card p-4 mb-4';

                let optionsText = '';
                if (record.noSafai) {
                    optionsText += `<span>ØµÙØ§Ø¦ÛŒ Ù†ÛÛŒÚºØŒ </span>`;
                }
                if (record.noKatoti) {
                    optionsText += `<span>Ú©Ù¹ÙˆØªÛŒ Ù†ÛÛŒÚºØŒ </span>`;
                }
                if (record.billInFlour) {
                    optionsText += `<span>Ø¨Ù„ Ø¢Ù¹Ø§ Ø³Û’ Ø§Ø¯Ø§ ÛÙˆÚ¯Ø§</span>`;
                }
                
                const statusColor = record.status === 'paid' ? 'text-green-600' : 'text-red-600';
                const statusText = record.status === 'paid' ? 'ÙˆØµÙˆÙ„ Ø´Ø¯Û' : 'Ø¨Ù‚Ø§ÛŒØ§';

                let paymentHistoryHtml = '';
                if (selectedType === 'khata' && record.paymentHistory && record.paymentHistory.length > 0) {
                    paymentHistoryHtml = `
                        <div class="mt-4 border-t pt-2">
                            <h4 class="font-bold text-sm mb-2">ÙˆØµÙˆÙ„ÛŒ Ú©Ø§ ØªØ§Ø±ÛŒØ®Ú†Û:</h4>
                            <div class="transactions-list">
                                ${record.paymentHistory.map(payment => `
                                    <div class="payment-history-item text-xs text-gray-600">
                                        <span>${payment.date}</span>
                                        <span>${payment.amount} Ø±ÙˆÙ¾Û’</span>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `;
                }

                let transactionHistoryHtml = '';
                if (selectedType === 'khata' && record.transactions && record.transactions.length > 1) {
                    transactionHistoryHtml = `
                        <details class="mt-4 border-t pt-2">
                            <summary class="font-bold text-sm mb-2 cursor-pointer text-blue-600">
                                Ù„ÛŒÙ† Ø¯ÛŒÙ† Ú©ÛŒ ØªÙØµÛŒÙ„Ø§Øª Ø¯Ú©Ú¾Ø§Ø¦ÛŒÚº (Ú©Ù„ ${record.transactions.length} Ø¯ÙØ¹Û)
                            </summary>
                            <div class="transactions-list">
                                ${record.transactions.map((t, index) => `
                                    <div class="transaction-item text-xs text-gray-600 mb-2">
                                        <p><strong>${index + 1}. ${t.transactionType}</strong></p>
                                        <p>ÙˆØ²Ù†: ${t.weight} Ú©Ù„ÙˆÚ¯Ø±Ø§Ù…ØŒ Ø±Ù‚Ù…: ${t.amount} Ø±ÙˆÙ¾Û’</p>
                                        <p>Ø®Ø§Ù„Øµ Ø¢Ù¹Ø§: ${t.netWeight} Ú©Ù„ÙˆÚ¯Ø±Ø§Ù…</p>
                                        <p>ØªØ§Ø±ÛŒØ®: ${t.date} | ÙˆÙ‚Øª: ${t.time}</p>
                                    </div>
                                `).join('')}
                            </div>
                        </details>
                    `;
                }
                
                const addWeightButton = selectedType === 'khata' ? `<button class="bg-purple-500 hover:bg-purple-600 text-white text-sm py-2 px-4 rounded-full transition-colors" data-action="add-weight" data-id="${record.id}" data-type="${selectedType}">ÙˆØ²Ù† Ø´Ø§Ù…Ù„ Ú©Ø±ÛŒÚº</button>` : '';

                recordItem.innerHTML = `
                    <p><strong>Ù†Ø§Ù…:</strong> ${record.customerName}</p>
                    <p><strong>ØªØ§Ø±ÛŒØ®:</strong> ${record.date}</p>
                    <p><strong>Ú©Ù„ ÙˆØ²Ù†:</strong> ${record.totalWeight} Ú©Ù„ÙˆÚ¯Ø±Ø§Ù…</p>
                    <p><strong>Ú©Ù„ Ú©Ù¹ÙˆØªÛŒ Ú©Ø§ ÙˆØ²Ù†:</strong> ${record.katotiWeight} Ú©Ù„ÙˆÚ¯Ø±Ø§Ù…</p>
                    <p><strong>Ú©Ù„ Ø¨Ù„ Ø±Ù‚Ù…:</strong> ${record.amount} Ø±ÙˆÙ¾Û’</p>
                    <p><strong>Ú©Ù„ Ø®Ø§Ù„Øµ Ø¢Ù¹Ø§:</strong> ${record.netWeight} Ú©Ù„ÙˆÚ¯Ø±Ø§Ù…</p>
                    ${selectedType === 'khata' ? `<p class="mt-2 text-sm ${statusColor}"><strong>Ø§Ø³Ù¹ÛŒÙ¹Ø³:</strong> ${statusText} | Ø¨Ù‚Ø§ÛŒØ§: ${record.balance} Ø±ÙˆÙ¾Û’</p>` : ''}
                    ${paymentHistoryHtml}
                    ${transactionHistoryHtml}
                    <div class="flex flex-wrap space-x-2 space-x-reverse mt-4">
                        <button class="bg-blue-500 hover:bg-blue-600 text-white text-sm py-2 px-4 rounded-full transition-colors" data-action="edit" data-id="${record.id}" data-type="${selectedType}">Ø§ÛŒÚˆÙ¹</button>
                        <button class="bg-red-500 hover:bg-red-600 text-white text-sm py-2 px-4 rounded-full transition-colors" data-action="delete" data-id="${record.id}" data-type="${selectedType}">ÚˆÛŒÙ„ÛŒÙ¹</button>
                        ${selectedType === 'khata' && record.status !== 'paid' ? `<button class="bg-green-500 hover:bg-green-600 text-white text-sm py-2 px-4 rounded-full transition-colors" data-action="pay" data-id="${record.id}" data-type="${selectedType}">ÙˆØµÙˆÙ„</button>` : ''}
                        ${addWeightButton}
                        ${selectedType === 'backup' ? `<button class="bg-orange-500 hover:bg-orange-600 text-white text-sm py-2 px-4 rounded-full transition-colors" data-action="move-to-khata" data-id="${record.id}" data-type="${selectedType}">Ú©Ú¾Ø§ØªÛ’ Ù…ÛŒÚº Ø´Ø§Ù…Ù„ Ú©Ø±ÛŒÚº</button>` : ''}
                    </div>
                `;
                recordsList.appendChild(recordItem);
            });
        }

        function renderSummary() {
            const khataRecords = JSON.parse(localStorage.getItem('khata')) || [];
            const backupRecords = JSON.parse(localStorage.getItem('backup')) || [];
            const combinedRecords = [...khataRecords, ...backupRecords];
            
            let filteredRecords = combinedRecords;
            if (dateFilter.value) {
                const filterDate = new Date(dateFilter.value).toLocaleDateString('ur-PK');
                filteredRecords = combinedRecords.filter(record => record.date === filterDate);
            }

            const totalNetWeight = filteredRecords.reduce((sum, record) => sum + parseFloat(record.netWeight), 0);
            const totalKatotiWeight = filteredRecords.reduce((sum, record) => sum + parseFloat(record.katotiWeight), 0);
            const totalAmount = filteredRecords.reduce((sum, record) => sum + parseFloat(record.amount), 0);
            
            recordsList.innerHTML = '';
            summarySection.classList.remove('hidden');
            totalNetWeightSpan.textContent = totalNetWeight.toFixed(2);
            totalKatotiWeightSpan.textContent = totalKatotiWeight.toFixed(2);
            totalAmountSpan.textContent = totalAmount.toFixed(2);
        }
    </script>
</body>
</html>

